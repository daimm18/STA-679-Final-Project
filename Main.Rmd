---
title: "Main"
author: "Michelle Dai"
date: '2022-04-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(causaldata)
library(dbplyr)
library(ggdag)
library(tidyverse)
library(broom)
data <- read.csv(file="marketing_campaign.csv")
```


Source of data: https://www.kaggle.com/datasets/imakash3011/customer-personality-analysis?select=marketing_campaign.csv


ID: Customer's unique identifier
Year_Birth: Customer's birth year
Education: Customer's education level
Marital_Status: Customer's marital status
Income: Customer's yearly household income
Kidhome: Number of children in customer's household
Teenhome: Number of teenagers in customer's household
Dt_Customer: Date of customer's enrollment with the company
Recency: Number of days since customer's last purchase
Complain: 1 if the customer complained in the last 2 years, 0 otherwise

MntWines: Amount spent on wine in last 2 years
MntFruits: Amount spent on fruits in last 2 years
MntMeatProducts: Amount spent on meat in last 2 years
MntFishProducts: Amount spent on fish in last 2 years
MntSweetProducts: Amount spent on sweets in last 2 years
MntGoldProds: Amount spent on gold in last 2 years

NumDealsPurchases: Number of purchases made with a discount
AcceptedCmp1: 1 if customer accepted the offer in the 1st campaign, 0 otherwise
AcceptedCmp2: 1 if customer accepted the offer in the 2nd campaign, 0 otherwise
AcceptedCmp3: 1 if customer accepted the offer in the 3rd campaign, 0 otherwise
AcceptedCmp4: 1 if customer accepted the offer in the 4th campaign, 0 otherwise
AcceptedCmp5: 1 if customer accepted the offer in the 5th campaign, 0 otherwise
Response: 1 if customer accepted the offer in the last campaign, 0 otherwise

NumWebPurchases: Number of purchases made through the company’s website
NumCatalogPurchases: Number of purchases made using a catalogue
NumStorePurchases: Number of purchases made directly in stores
NumWebVisitsMonth: Number of visits to company’s website in the last month



Causal Question: Do people who made more web visit purchase more compared with people who made less web visit?

```{r}
data$TotalPurchase <- data$NumWebPurchases+ data$NumCatalogPurchases+data$NumStorePurchases
data_sub <- data %>% select(Year_Birth, Education, Marital_Status, Income, Kidhome, Teenhome, Recency, Complain, NumDealsPurchases, TotalPurchase, NumWebVisitsMonth)


```

## Missing Data Imputation

```{r, message=FALSE, warning=FALSE}
library(visdat)
vis_dat(data_sub) #+ labs(title = "Missing Data For Sub Dataset")
```



```{r}
# impute missing data on alcoholhowmuch
library(mice)
library(MatchThem)
library(survey)
#set.seed(1)

#data_sub_imp <- mice(data_sub, 5, "pmm", printFlag = FALSE)

data_sub_complete <- na.omit(data_sub)

data_sub_complete <- data_sub_complete %>% mutate(NumWebVisitsMonth = ifelse(NumWebVisitsMonth>=7, 1, 0))
```

```{r}
data_sub_complete <- data_sub_complete %>% 
  mutate(Education = ifelse(Education == "2n Cycle", 0, Education))%>% 
  mutate(Education = ifelse(Education == "Basic", 1, Education)) %>% 
  mutate(Education = ifelse(Education == "Graduation", 2, Education)) %>% 
  mutate(Education = ifelse(Education == "Master", 3, Education)) %>% 
  mutate(Education = ifelse(Education == "PhD", 4, Education)) %>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Single", 0, Marital_Status)) %>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Together", 1, Marital_Status))%>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Married", 2, Marital_Status))%>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Divorced", 3, Marital_Status))%>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Widow", 4, Marital_Status))%>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Alone", 5, Marital_Status))%>% 
  mutate(Marital_Status = ifelse(Marital_Status == "Absurd", 6, Marital_Status))%>% 
  mutate(Marital_Status = ifelse(Marital_Status == "YOLO", 7, Marital_Status))
  
```



```{r}
purchase <- dagify(
  NumWebVisitsMonth ~ Year_Birth + Education +Marital_Status+ Kidhome + Teenhome + Recency + NumDealsPurchases,
  TotalPurchase ~ Marital_Status + Income + Kidhome + Teenhome + Recency + Complain + NumDealsPurchases,
  exposure = "NumWebVisitsMonth",
  outcome = "TotalPurchase",
  labels = c(
    NumWebVisitsMonth = "#Web Visit Last Month",
    Year_Birth = "Birth Year",
    Education = "Education",
    Marital_Status = "Marital Status",
    Kidhome = "#Kids at Home",
    Teenhome = "#Teenagers at Home",
    Recency = "#Days since Last Purchase",
    NumDealsPurchases = "#Purchase using Discount",
    Income = "Income",
    TotalPurchase = "Total Purchase",
    Complain = "Complain"
  )
)
ggdag_status(purchase, use_labels = "label", text = FALSE) +
  guides(fill = "none", color = "none")

dagify(
  NumWebVisitsMonth ~ Year_Birth + Education +Marital_Status+ Kidhome + Teenhome + Recency + NumDealsPurchases,
  TotalPurchase ~ Marital_Status + Income + Kidhome + Teenhome + Recency + Complain + NumDealsPurchases,
  exposure = "NumWebVisitsMonth",
  outcome = "TotalPurchase",
  labels = c(
    NumWebVisitsMonth = "#Web Visit Last Month",
    Year_Birth = "Birth Year",
    Education = "Education",
    Marital_Status = "Marital Status",
    Kidhome = "#Kids at Home",
    Teenhome = "#Teenagers at Home",
    Recency = "#Days since Last Purchase",
    NumDealsPurchases = "#Purchase using Discount",
    Income = "Income",
    TotalPurchase = "Total Purchase",
    Complain = "Complain"
  )
) %>%
ggdag_adjustment_set(text_col = "black")
```

## Propensity Score Model

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
library(broom)
library(smd)
library(gtsummary)
library(survey)

data_sub_complete %>%
  tbl_summary(
    by = NumWebVisitsMonth, 
    include = c(
      "Year_Birth", "Education", "Marital_Status", "Kidhome", "Teenhome", "Recency", "NumDealsPurchases")) %>%
  add_overall()
```


```{r, results='hide', message=FALSE, warning=FALSE}
data_sub_complete <- 
  glm(NumWebVisitsMonth ~ Year_Birth + as.factor(Education) +as.factor(Marital_Status)+ Kidhome + Teenhome + Recency + NumDealsPurchases, 
    data = data_sub_complete,
    family = binomial()) %>%
  augment(type.predict = "response",
          data = data_sub_complete) # concatenation
data_sub_complete %>%
  select(NumWebVisitsMonth, .fitted)
```

```{r, message=FALSE, warning=FALSE}
ggplot(data_sub_complete, aes(x= .fitted, fill = as.factor(NumWebVisitsMonth))) + 
  geom_histogram(bins = 30) +geom_vline(xintercept = median(data_sub_complete[data_sub_complete$NumWebVisitsMonth == 0, ]$.fitted), linetype="twodash", 
                color = "red", size=1)+geom_vline(xintercept = median(data_sub_complete[data_sub_complete$NumWebVisitsMonth == 1, ]$.fitted), linetype="twodash", 
                color = "turquoise4", size=1)+
  labs(x="Propensity Score", y="Count", title= "Distribution of Propensity Score")

median(data_sub_complete[data_sub_complete$NumWebVisitsMonth == 0, ]$.fitted)
median(data_sub_complete[data_sub_complete$NumWebVisitsMonth == 1, ]$.fitted)
```

```{r, message=FALSE, warning=FALSE}
data_sub_complete <- glm(NumWebVisitsMonth ~ Year_Birth + as.factor(Education) +as.factor(Marital_Status)+ Kidhome + Teenhome + Recency + NumDealsPurchases,
                         data=data_sub_complete, family = binomial()) %>%
  augment(data_sub_complete, type.predict = "response") %>%
  mutate(wt_ato = (1 - NumWebVisitsMonth)* .fitted + NumWebVisitsMonth * (1 - .fitted))
```


```{r, message=FALSE, warning=FALSE}
des <- svydesign(
  ids = ~1,
  data =  data_sub_complete,
  weight = ~ wt_ato
)

des %>%
  tbl_svysummary(
    by = NumWebVisitsMonth, 
    include = c(
      "Year_Birth", "Education", "Marital_Status", "Kidhome", "Teenhome", "Recency", "NumDealsPurchases")) %>%
  add_overall()
```

```{r, message=FALSE, warning=FALSE}

#df_plot_ps <- data_sub_complete %>% distinct() %>%
#  tidyr::pivot_wider(names_from = income,
#                     values_from = .fitted, 
#                     names_prefix = "income_p")

for_plot <- data_sub_complete %>%
  pivot_wider(names_from = NumWebVisitsMonth,
              values_from = .fitted,
              names_prefix = "NumWebVisitsMonth_p")
#for_plot <- as.data.frame(for_plot)
#for_plot$NumWebVisitsMonth_p1 <- unlist(for_plot$NumWebVisitsMonth_p1)
#for_plot$NumWebVisitsMonth_p0 <- unlist(for_plot$NumWebVisitsMonth_p0)
```


```{r, message=FALSE, warning=FALSE}
ggplot(for_plot) +
  geom_histogram(bins = 50,
                 aes(x = NumWebVisitsMonth_p1, 
                     weight = wt_ato),  
                 fill = "cornflower blue") +
  geom_histogram(bins = 50,
                 aes(x = NumWebVisitsMonth_p0,
                     weight = wt_ato,
                     y = - stat(count)),
                 fill = "orange") + 
  scale_y_continuous("Count", label = abs) + 
  scale_x_continuous("Propensity Score (ATO Weighted)") +
  geom_label(
    label = "Visit >= 7", 
    x = 0.1,
    y = 10,
  )+
    geom_label(
    label = "Visit < 7", 
    x = 0.1,
    y = -10,
  )+ labs(title= "Distribution of Propensity Score (ATO Weighted)")
```

```{r, message=FALSE, warning=FALSE}
ecdf_1 <- data_sub_complete %>%
  filter(NumWebVisitsMonth == 1) %>%
  arrange(Income) %>%
  mutate(cum_pct_ato = cumsum(wt_ato) / sum(wt_ato))

ecdf_0 <- data_sub_complete %>%
  filter(NumWebVisitsMonth == 0) %>%
  arrange(Income) %>%
  mutate(cum_pct_ato = cumsum(wt_ato) / sum(wt_ato))
```

```{r, message=FALSE, warning=FALSE}
ggplot(ecdf_1, aes(x = Income, y = cum_pct_ato, color = "Yes")) +
  geom_line() +
  geom_line(data = ecdf_0, 
            aes(x = Income, y = cum_pct_ato, color = "No")) + labs(x = "Income after ATO weighting", y = "(ATO Weighted) Percent <= x", title="ATO Weighted ECDF for Income", color = "NumWebVisitsMonth")
```

```{r, message=FALSE, warning=FALSE}
library(rsample)
library(PSW)
#fit inverse probablity weight model
fit_ipw <- function(split, ...) {
  .df <- analysis(split)
  # fit propensity score model
  propensity_model <- glm(
    NumWebVisitsMonth ~ Year_Birth + as.factor(Education) +as.factor(Marital_Status)+ Kidhome + Teenhome + Recency + NumDealsPurchases,
    data = .df,
    family = binomial()
  )
  # calculate inverse probability weights
  .df <- propensity_model %>% 
    augment(type.predict = "response", data = .df) %>% 
    mutate(wt_ato = (1 - NumWebVisitsMonth)* .fitted + NumWebVisitsMonth * (1 - .fitted))
  # fit correctly bootsrapped ipw model
  # outcome model 
  lm(TotalPurchase ~ NumWebVisitsMonth, data = .df, weights = wt_ato) %>% 
    tidy()
}

# fit ipw model to bootstrapped samples
ipw_results <- bootstraps(data_sub_complete, 1000, apparent = TRUE) %>% 
  mutate(results = map(splits, fit_ipw))
```

```{r, message=FALSE, warning=FALSE}
# get t-statistic-based CIs
boot_estimate <- int_t(ipw_results, results) %>%
  filter(term == c("(Intercept)", "NumWebVisitsMonth"))
boot_estimate
```






## Do a overlapping propensity score distribution over unweighted and weighted








